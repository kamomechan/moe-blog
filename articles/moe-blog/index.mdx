import Image from "next/image";
import i1 from "./images/1.webp";
import i2 from "./images/2.webp";
import i3 from "./images/3.webp";
import i4 from "./images/4.webp";

export const metadata = {
  title: "moe-blog",
  date: "2025-11-08",
  description: "使用 nextjs 构建的萌萌 blog",
  edit: "2025-11-30",
};

# moe-blog

## 简介

使用 nextjs 构建的萌萌 blog

## lighthouse

home page:

<Image src={i1} alt="screenshort" />
<Image src={i2} alt="screenshort" />

post page:

<Image src={i3} alt="screenshort" />
<Image src={i4} alt="screenshort" />

## 任务清单

- [x] 导航栏

- [x] 分页

- [x] markdown to html

- [x] 代码语法高亮/复制按钮

- [x] 文章侧边栏

- [x] RSS

- [x] VNDB 阅读列表

- [x] ~~类似 Pixiv 的~~图片查看器

- [x] 搜索框

- [x] 黑暗模式

- [ ] 评论功能 (打算使用 Postgres 作为数据库)

## 部署

### 克隆仓库

```shell
git clone https://codeberg.org/nokutan/moe-blog.git
```

或者

```shell
git clone https://github.com/kamomechan/moe-blog.git
```

### 运行环境

下载 [nodejs](https://nodejs.org/en/download) 最新的 LTS 版本

### 依赖

```shell
npm i -g pnpm
pnpm i
```

### 配置

根据`.env.example`注释进行配置

```shell
cp .env.example .env
vim .env
```

### 部署到开发环境

```shell
pnpm run dev
```

### 部署到生产环境

```shell
pnpm run build
pnpm start
```

## 日志

- 2025-11-08 本来想使用 mdx 的，不过不支持直接导入相对路径的图片，暂且放弃，主要是因为在 markdown 文件中使用 import 有点麻烦，改天再试试，如果对 lighthouse 提升较大就使用

- 2025-11-09 切换到 mdx compiler 试试，顺便开启 GFM 插件

- 2025-11-09 测试了下性能果然提升了，毕竟 mdx 支持使用 Image 等组件嘛，与之相对的 marked 库只能转换 html，没有懒加载，自动设置尺寸等优化

- 2025-11-14 使用 VNDB-API 根据 User ID 获取投票前几的视觉小说，静态路由默认缓存图片和条目，这意味着仅请求一次，符合 [vndb-api](https://api.vndb.org/kana#usage-terms) 速率限制周期

- 2025-11-15 目前所有路由都为 SSG 渲染，之后的评论功能预计使用 ISR 渲染

- 之前为分页功能实现 SSG 思考了一段时间，首先排除使用 `searchParams props`，这会将路由变为动态的 SSR。其次排除使用 `useSearchParams hooks`，这会增加客户端包的体积并且数据离服务端近，如果使用 api-token 还会暴露。这样搜索参数就无法使用了，但可以改为路径，也就是使用 `params props` 获取路径的页码。但是又有个新问题，如果直接使用 `/[slug]` 获取页码，首页就需要重定向到 `/1`,这会影响 SEO 和加载速度，~~到这里思考停止了~~，直到查看[文档](https://nextjs.org/docs/app/api-reference/file-conventions/dynamic-routes#optional-catch-all-segments)无意间看到 `[[...slug]]` 的 slug 参数如果返回 undefined 会回到上一个路由段，也就是说我完全可以利用这个特性，而不是使用重定向，实现相同的效果，结合 `generateStaticParams()`，完美实现 SSG 渲染

- 2025-11-17 目前只做了简单的图片缩放，~~实际上是类似 pixiv 移动端的图片缩放功能，手动实现起来有点复杂，我又不太想使用别人写好的库~~，暂时先咕咕咕了

- 本来以为比较简单，改改 scale 和 translate 属性就好了,但双击缩放的功能，还需要计算一些东西，目前还不能理解下面的公式

- cx​=px​\*S+tx​

- cy-py\*S+ty

- px​=(cx​−tx​​)/S

- py​=(cy​−ty)/S​​

- tx′​=cx​−((cx​−tx​​)/S)×S′

- ty′​=cy​−((cy​−ty​​)/S)×S′

- cx​,cy​: 鼠标点击的视口坐标。

- tx​,ty​: 当前的平移量 (translate.x, translate.y)。

- S: 当前的缩放比例 (scale)。

- px​,py​: 缩放中心点在原始图片坐标系中的位置。

- 2025-11-19 新增了搜索框，首先对于个人 blog 而言，SSG 渲染更适合，对于实现的搜索页面而言，这需要排除 `searchParams props`，这意味我们可以使用 `useSearchParams hooks` 来更新搜索参数。虽说我们也可以使用路径参数的 `params props` 替代，以减少客户端包体积，但是这会导致路径污染，而简单的首页分页使用 `params props` 来获取页码参数却是最佳实践，但是搜索页面不太合适。另外就是搜索数据如何筛选处理的问题，既然我们根据权衡选择了 `hooks`,那么就变成了客户端组件，这时我们需要从客户端获取数据，有两个选择，一个是选择从客户端获取服务端预构建的索引数据 json 文件，并筛选显示；另一个选择是构建一个路由 api，传递搜索参数，服务端处理数据筛选后返回给客户端渲染。如何选择呢，首先回归到问题本质，选择 SSG 是为了 FCP (First Contentful Paint) 速度，而剩下的两个选择是否有一个影响呢，第一个选项需要客户端获取 json 索引文件可能会影响，而第二个选项只会在执行搜索时才会执行，那么第二个选择是权衡后比较适合的选择，即 SSG + api route 混合渲染(Hybrid rendering)

- 2025-11-20 添加了切换主题的按钮，之后再为每个页面添加样式

- 2025-11-21 添加了评论 UI，另外把 [github](https://github.com/kamomechan/) 的代码迁移到了 [codeberg](https://codeberg.org/nokutan)，当然两个远程存储库之间会同步的，不过之后如果有新项目的话就不一定了

- 2025-11-22 添加了嵌套评论的样式

- 2025-11-26 为帖子页面的评论功能实现 ISR 渲染时遇到个问题，已提[issue](https://github.com/vercel/next.js/discussions/86503)，但未得到解决，目前使用 SSG + api route 混合渲染来作为替代方案，这样有个好处，如果将来~~有好多好多人~~评论可以实现 Load More，而不用担心一个静态页面在首次加载时包含体积过大的评论文本

- 对于评论功能的 spam 预防，目前设计了 `honeypot field` 和是否触发滚动等方式来阻止。如果效果微乎其微的话，再考虑其他方式，~~比方说本地部署轻量级的 FOSS(Free and Open Source Software) AI 来检查评论文本 w~~，其实对于个人项目来说还真能这么做。总之是不会给评论功能添加登录注册的，包括第三方登录等等，因为我也不想在回复别人评论时还要进行登录注册操作，这也是我为什么没有使用第三方的 api 来实现评论功能，而是手动实现。不过之后会预留一个 admin 账号或令牌用来删除 spam 评论

- 2025-11-30 由于我想要访客发评论并不需要登录，并且可以编辑和删除自己的帖子。使用数据库存储会话有点不太合适，因此选择了 stateless 会话。于是便用 jwt 的 payload 直接记录访客发表的帖子 id，并存储在 http-cookie 中，最后在服务端验证签名，设置了 7 天的有效时间，7 天内再次访问会刷新会话时间。之前想使用 [next-auth](https://www.npmjs.com/package/next-auth) 来进行会话管理的，它默认使用的就是 jwt 并做了点抽象，不过它似乎只能在 authentication 后才能管理会话，因此并不适合这个场景（不得不说，next-auth 的文档看起来有点~~云里雾里的 くもくも~~

## License

GNU AGPLv3

## Others

The background image for the mobile view is [Xid](https://x.com/adahemas3/status/1907807574822703429),
and the background image for the desktop view is [Pid:124691047](https://www.pixiv.net/artworks/124691047).
